★【ハンズオン1】基本的なブログサービスを構築する（シングル構成）
▼構成
	![[Pasted image 20250718190534.png]]
①vpcとサブネットの作成
![[Pasted image 20250718190706.png]]
	・vpc
		![[Pasted image 20250718191057.png]]
		作成
	・パブリックサブネット
		![[Pasted image 20250718191313.png]]
		作成
	・プライベートサブネット
		![[Pasted image 20250718191554.png]]
		作成
②EC2の作成
	![[Pasted image 20250718191711.png]]
	・キーペア作成
		![[Pasted image 20250718192425.png]]
	・EC2
		![[Pasted image 20250718193027.png]]
		![[Pasted image 20250718193037.png]]
		![[Pasted image 20250718193049.png]]
		![[Pasted image 20250718193058.png]]
		作成
③インターネットゲートウェイの作成
	![[Pasted image 20250718193348.png]]
	作成
	![[Pasted image 20250718193411.png]]
	アタッチ
④ルートテーブルの作成と設定
	・設定
		![[Pasted image 20250718193630.png]]
	・プライベート用のルートテーブルの作成
		![[Pasted image 20250718193839.png]]
	・関連付けの設定
		![[Pasted image 20250718193957.png]]
⑤EC2に接続
	・キーペアの権限の変更
		![[Pasted image 20250718195751.png]]
	・接続
		ssh -i Mykeypair.pem ec2-user@54.248.49.247
		![[Pasted image 20250718195947.png]]
⑥RDSとサブネットグループの作成
![[Pasted image 20250718200304.png]]
	・パブリックサブネットの作成
		![[Pasted image 20250718200459.png]]
		作成
	・プライベートサブネットの作成
		![[Pasted image 20250718200605.png]]
		作成
	・サブネットグループの作成
		![[Pasted image 20250718201132.png]]
		![[Pasted image 20250718201142.png]]
		作成
	・データベースの作成
		![[Pasted image 20250718202231.png]]
		![[Pasted image 20250718202246.png]]
		![[Pasted image 20250718202257.png]]
		![[Pasted image 20250718202308.png]]
		![[Pasted image 20250718202444.png]]
		![[Pasted image 20250718202458.png]]
		![[Pasted image 20250718202605.png]]
		作成
	・セキュリティグループの設定
		![[Pasted image 20250718210227.png]]
⑦wordpressのインストール
	・以下コマンド
		sudo dnf -y update
		sudo dnf -y install httpd php php-mysqlnd \
                     php-mbstring php-xml \
                     gd php-gd
        sudo systemctl enable --now httpd
        cd /tmp
		curl -LO https://ja.wordpress.org/latest-ja.tar.gz
		tar xzf latest-ja.tar.gz
		sudo rm -rf /var/www/html/*
		sudo cp -r wordpress/* /var/www/html/
		sudo chown -R apache:apache /var/www/html
		sudo find  /var/www/html -type f -exec chmod 644 {} \;
		sudo find  /var/www/html -type d -exec chmod 755 {} \;
⑧wordpressの設定
	![[Pasted image 20250718212747.png]]
	ユーザー名：DBのユーザー名
	パスワード：DBのパスワード
	データベースのホスト名：エンドポイント
	送信
	![[Pasted image 20250718213103.png]]
★【ハンズオン1】補足_EC2再起動後に ブログ表示に時間がかかる、 および表示が崩れる場合の対応手順
▼以下コマンド実行
	# MariaDB 10.5 クライアントをインストール
	sudo dnf install -y mariadb105
	mysql -h database-1.cbsukm0we4kp.ap-northeast-1.rds.amazonaws.com \
      -u wordpress -p
	USE wordpress
	SELECT * FROM wp_options WHERE option_name IN ('siteurl', 'home');
	UPDATE wp_options SET option_value = 'http://xx.xx.xx.xx' WHERE option_name IN ('siteurl', 'home');
	上記のURLの箇所にEC2再起動によって変更されたIPアドレスを入力し更新する


★【ハンズオン2】冗長性のあるブログサービスを構築する（冗長構成）
▼概要
	![[Pasted image 20250724205137.png]]
①EC2とRDSを再起動する
②Websever1のindex.phpの編集
	以下コマンド実行
	ssh接続：ssh -i Mykeypair.pem ec2-user@
	管理者権限：sudo su -
	ディレクトリ移動：cd /var/www/html/
	index.phpを開く：vi index.php
	追記：echo '<p　>Web Server 1<　/p>';
③EC2のAMIを取得
	EC2を停止させる
	![[Pasted image 20250724211838.png]]
	![[Pasted image 20250724211938.png]]
	他デフォルトで作成する
④AMIからEC2を作成
	![[Pasted image 20250724215028.png]]
	![[Pasted image 20250724214615.png]]
	![[Pasted image 20250724215042.png]]
	![[Pasted image 20250724215059.png]]
⑤Websever1のindex.phpの編集
	以下コマンド実行
	ssh接続：ssh -i Mykeypair.pem ec2-user@
	管理者権限：sudo su -
	ディレクトリ移動：cd /var/www/html/
	index.phpを開く：vi index.php
	追記：echo '<p　>Web Server 2<　/p>';
⑥ELBの作成
	![[Pasted image 20250724220313.png]]
	![[Pasted image 20250724220323.png]]
	![[Pasted image 20250724220333.png]]
	![[Pasted image 20250724220343.png]]
⑦RDSのデータベース情報を修正
	mysql -h database-1.cbsukm0we4kp.ap-northeast-1.rds.amazonaws.com \
      -u wordpress -p
	USE wordpress
	SELECT * FROM wp_options WHERE option_name IN ('siteurl', 'home');
	UPDATE wp_options SET option_value = 'http://xx.xx.xx.xx' WHERE option_name IN ('siteurl', 'home');
	上記のURLの箇所にELBのDNS名を入力し更新する
	確認：http://lb-1-1905223170.ap-northeast-1.elb.amazonaws.com/
	![[Pasted image 20250724221819.png]]
⑧WebServerのセキュリティグループ設定の変更
	![[Pasted image 20250724222942.png]]
⑨障害テスト
	EC2の片方をシャットダウン
	![[Pasted image 20250724223202.png]]
	更新を続けてもWebServer2が表示される
	WebServer1を再起動したら１も表示されるようになる
⑩RDSをマルチAZ構成に変更
	RDSを選択し変更する
	![[Pasted image 20250724223939.png]]
	フェイルオーバーして再起動
	![[Pasted image 20250724225238.png]]


★【ハンズオン3】スケーラビリティのあるブログサービスを構築する
▼概要
	![[Pasted image 20250724231441.png]]
①Auto Scallingの設定
	![[Pasted image 20250724234117.png]]
	![[Pasted image 20250724234126.png]]
	![[Pasted image 20250724234152.png]]
	![[Pasted image 20250724234318.png]]
	![[Pasted image 20250724234327.png]]
	![[Pasted image 20250724234337.png]]
	![[Pasted image 20250724234508.png]]
	![[Pasted image 20250724234517.png]]
	![[Pasted image 20250724234529.png]]
	![[Pasted image 20250724234538.png]]
	作成
②アラームの設定
	![[Pasted image 20250725002406.png]]
	![[Pasted image 20250725002515.png]]
	![[Pasted image 20250725002545.png]]
	![[Pasted image 20250725002628.png]]
	作成
	もう一つ
	![[Pasted image 20250725002733.png]]
	![[Pasted image 20250725002754.png]]
	![[Pasted image 20250725002826.png]]
	作成
③アラームとの紐付け
	![[Pasted image 20250725003119.png]]
	![[Pasted image 20250725003154.png]]
④動作テスト
	負荷をかける
	yes >> /dev/null &
	確認
	top
	![[Pasted image 20250725005025.png]]
	![[Pasted image 20250725005003.png]]
	![[Pasted image 20250725005050.png]]
	インスタンスが追加された
	![[Pasted image 20250725005209.png]]
	![[Pasted image 20250725012257.png]]
	CPU使用率を下げたらインスタンスは削除された


★【ハンズオン3-a】CloudWatchでログ監視をする
▼概要
	![[Pasted image 20250728164710.png]]
①Apacheをインストール
```
# 1. 権限昇格（どちらか）
sudo -i               # ← 常にrootで作業したい場合
# もしくはコマンド毎に sudo を付ける

# 2. パッケージ更新（任意）
sudo dnf -y update

# 3. Apache(HTTPD) をインストール
sudo dnf -y install httpd

# 4. 自動起動＆起動
sudo systemctl enable --now httpd
```
②cloudwatchlogsのエージェントをインストールする
	sudo dnf install -y amazon-cloudwatch-agent
③accesslogとerrerlogの設定
	sudo vi /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
```
{
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {
            "file_path": "/var/log/httpd/access_log",
            "log_group_name": "/HttpAccessLog",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%b %d %H:%M:%S"
          },
          {
            "file_path": "/var/log/httpd/error_log",
            "log_group_name": "/HttpErrorLog",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%b %d %H:%M:%S"
          }
        ]
      }
    }
  }
}
```
	反映して起動
	sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config -m ec2 \
  -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json -s
④Iamロールの作成とアタッチ
	![[Pasted image 20250728174757.png]]
	ec2にアタッチ
	![[Pasted image 20250728174835.png]]
⑤確認
	![[Pasted image 20250728174915.png]]


★# 【ハンズオン4_説明】独自ドメインを設定する / 障害時はSORRYページへ通信を流す
▼概要
	![[Pasted image 20250728175422.png]]
①任意のドメインを取得する
	![[Pasted image 20250728181242.png]]
②Route53にてホストゾーンの設定をする
	![[Pasted image 20250728182521.png]]
③お名前.com側で設定をする
	![[Pasted image 20250728182958.png]]
④ELBルーティング用のレコードの設定
	![[Pasted image 20250728183546.png]]
	レコードを作成
⑤S3バケットの作成
	![[Pasted image 20250728191742.png]]
	上記画像のファイルとフォルダをアップロードする
	アクセス許可にてバケットポリシーを設定する
		![[Pasted image 20250728191841.png]]
	静的ウェブサイトホスティングの設定をする
		![[Pasted image 20250728191934.png]]
⑥フェイルオーバールーティングの設定
	プライマリ
		![[Pasted image 20250728192044.png]]
	セカンダリ
		![[Pasted image 20250728192136.png]]
⑦ec2を停止し確認
	60秒後に以下の表示
		![[Pasted image 20250728192250.png]]

★#HTTPS通信でアクセス可能にする
▼概要
	![[Pasted image 20250728192624.png]]
①ELBにリスナーを追加
	![[Pasted image 20250728193414.png]]
	上記画像で設定した証明書を選択する
②セキュリティグループの設定を変更する
	![[Pasted image 20250728193759.png]]
③表示が崩れるので設定を変更する
	![[Pasted image 20250728194203.png]]
	以下を追加
	![[Pasted image 20250728194336.png]]
④2台目のec2にも同様の設定を実施
⑤httpから通信を受け付けないように設定をする
	![[Pasted image 20250728194627.png]]
	上記画像のhttpのルールを削除する
	ロードバランサーのリスナーからも削除
		![[Pasted image 20250728194756.png]]
		上記画像の項目を削除


★キャッシュサーバーを配置する
▼概要
	![[Pasted image 20250728195253.png]]
①ドメインとALBの紐付けの設定を変更する
	![[Pasted image 20250728195620.png]]
	![[Pasted image 20250728195644.png]]
②ALB証明書の再作成
	![[Pasted image 20250728200109.png]]
	上記で作成した証明書を選択
		![[Pasted image 20250728200404.png]]
③バージニアリージョンに変更して同様に設定
④cloudfrontの作成
	![[Pasted image 20250728200937.png]]
	確認
	URL：d3ghjsyzmtbo04.cloudfront.net
⑤cloudfrontへのルートの設定
	![[Pasted image 20250728201332.png]]
	![[Pasted image 20250728201337.png]]
